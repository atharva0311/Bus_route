{% extends 'base.html' %}
{% block content %}
<div class="container py-4" style="margin-right: 340px;">
    <h2>Welcome, {{ user.username }}!</h2>
    <div class="card my-4">
        <div class="card-header">Recent Bookings</div>
        <div class="card-body">
            </div>
    </div>

    <div id="kmt-sidebar" style="position:fixed; top:0; right:0; width:320px; height:100vh; background:#f8f9fa; border-left:2px solid #28a745; display:flex; flex-direction:column; z-index:1050;">
        <div style="background:#28a745; color:white; padding:20px; text-align:center; font-weight:bold;">ðŸšŒ KMT AI Assistant</div>
        <div id="chat-messages" style="flex-grow:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; gap:10px;">
            <div style="background:#e9ecef; padding:10px; border-radius:10px; align-self:flex-start;">Namaskar! How can I help?</div>
        </div>
        <div style="padding:15px; display:flex; gap:5px; border-top:1px solid #ddd;">
            <button onclick="startVoice()" type="button" style="background:#28a745; color:white; border:none; border-radius:50%; width:40px; height:40px;">ðŸŽ¤</button>
            <input type="text" id="chat-input" placeholder="Type here..." style="flex-grow:1; border-radius:20px; border:1px solid #ccc; padding:10px;">
            <button onclick="sendMessage()" type="button" style="background:#28a745; color:white; border:none; border-radius:50%; width:40px; height:40px;">âž¤</button>
        </div>
    </div>
</div>

<script>
// 1. GET CSRF TOKEN (Django Security)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 2. THE SEND FUNCTION
async function sendMessage() {
    const input = document.getElementById('chat-input');
    const msgContainer = document.getElementById('chat-messages');
    const text = input.value.trim();
    if (!text) return;

    // Add User Message to UI
    const userDiv = document.createElement('div');
    userDiv.style.cssText = "background:#007bff; color:white; padding:10px; border-radius:10px; align-self:flex-end; margin-left:auto;";
    userDiv.innerText = text;
    msgContainer.appendChild(userDiv);
    input.value = '';

    try {
        const response = await fetch("/bookings/api/chat/", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie('csrftoken') 
            },
            body: JSON.stringify({ message: text })
        });

        if (!response.ok) {
            // THIS WILL TELL US THE ERROR CODE (e.g., 403, 404, 500)
            alert("Server Error: " + response.status);
            return;
        }

        const data = await response.json();
        const botDiv = document.createElement('div');
        botDiv.style.cssText = "background:#e9ecef; color:black; padding:10px; border-radius:10px; align-self:flex-start;";
        botDiv.innerText = data.reply || "Error: " + data.error;
        msgContainer.appendChild(botDiv);
        msgContainer.scrollTop = msgContainer.scrollHeight;

    } catch (e) {
        alert("Connection Failed: " + e);
    }
}

// 3. VOICE LOGIC
const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.onresult = (e) => { document.getElementById('chat-input').value = e.results[0][0].transcript; sendMessage(); };
function startVoice() { recognition.start(); }
</script>
{% endblock %}
